# Econ 172 PS3 R code by Tianlang Gao, April 18, 2018

# Set working directory and open dataset
setwd("~/Desktop")
witch <- read.csv("Econ-172_PSet3-Spring2018-data.csv")

# Construct variable for total murders
witch$total_murders <- witch$witch_murders + witch$oth_murders

# Produce summary statistics table with Stargazer
library(stargazer)
stargazer(witch, type = "html", title="Table 1: Summary Statistics", 
          out="Summary statistics.html")

# Regress total murders on flood variable, clustering error by village. 
library(multiwayvcov)
reg1 <- lm(total_murders ~ any_rain, data = witch)
cl_se1 <- sqrt(diag(cluster.vcov(reg1,witch$vid)))

# Regress total murders on flood variable, education, and traditional 
# religion, clustering error by village.
reg2 <- lm(total_murders ~ any_rain + educat + trad_relig, data = witch)
cl_se2 <- sqrt(diag(cluster.vcov(reg2,witch$vid)))

# Output regression 1 and 2 using stargazer, correcting for clustered SE
stargazer(reg1, reg2, out="Regressions on flood.html", type="html",  
          se=list(cl_se1, cl_se2), no.space=TRUE, align=TRUE,
          title="Table 2: Impact of Flood or Drought")

# Regress total murders on disease variable, clustering error by village. 
library(multiwayvcov)
reg3 <- lm(total_murders ~ any_disease, data = witch)
cl_se3 <- sqrt(diag(cluster.vcov(reg3,witch$vid)))

# Regress total murders on disease variable, education, and traditional 
# religion, clustering error by village.
reg4 <- lm(total_murders ~ any_disease + educat + trad_relig, data = witch)
cl_se4 <- sqrt(diag(cluster.vcov(reg4,witch$vid)))

# Output regression 3 and 4 using stargazer, correcting for clustered SE
stargazer(reg3, reg4, out="Regressions on disease.html", type="html",  
          se=list(cl_se3, cl_se4), no.space=TRUE, align=TRUE,
          title="Table 3: Impact of Disease Epidemic")

# Calculate the proportion of total murders, and instances of drought and 
# flood in villages in a given year
library(doBy)
proportion <- summaryBy(total_murders + any_rain ~ year, data = witch)

# Plot the average for total murders and flood or drought per year
png(file="Plot 1.png")
plot(proportion$year, proportion$any_rain.mean, type="b", pch=18, lty=2, 
     col="red", xlab="Year", ylab="Proportion")
lines(proportion$year, proportion$total_murders.mean, pch=19, col="blue", 
      type="b")
legend("topright", legend=c("Total Murders", "Flood or Drought"),
       col=c("blue", "red"), pch=c(19, 18), lty=c(2,1), pt.cex = 1) 
title("Proportion of total murders and flood or drought in villages")
dev.off()

# Run first stage regression of famine on extreme weathers, with controls.
# Report regression with stargazer
reg5 <- lm(famine ~ any_rain + educat + trad_relig, data = witch)
stargazer(reg5, out="First stage regression.html", type="html", no.space=TRUE, 
          align=TRUE, title="Table 4: First Stage Regression")

# Run IV regression of total murders on famine, with extreme weather conditions
# as instrument, plus controls. Report regression with stargazer
library(ivpack)
reg6 <- ivreg(total_murders ~ famine + educat + trad_relig | any_rain + educat 
        + trad_relig, x = TRUE, data = witch)
stargazer(reg6, out="IV regression.html", type="html", no.space=TRUE, 
          align=TRUE, title="Table 5: IV Regression")
